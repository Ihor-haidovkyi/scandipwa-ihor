{"ast":null,"code":"import _regeneratorRuntime from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";/* eslint-disable no-console */ /**\n * ScandiPWA - Progressive Web App for Magento\n *\n * Copyright © Scandiweb, Inc. All rights reserved.\n * See LICENSE for license details.\n *\n * @license OSL-3.0 (Open Software License (\"OSL\") v. 3.0)\n * @package scandipwa/base-theme\n * @link https://github.com/scandipwa/base-theme\n */import{PureComponent}from'react';import Loader from\"/home/marketihor/scandipwa/packages/scandipwa/src/component/Loader\";import KlarnaQuery from\"/home/marketihor/scandipwa/packages/scandipwa/src/query/Klarna.query\";import{isSignedIn}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Auth\";import{getGuestQuoteId}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Cart\";import{fetchMutation}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Request\";import{KLARNA_PAYMENTS_CONTAINER_ID,KLARNA_PAYMENTS_DEVICE_RECOGNITION_ID,KLARNA_SCRIPT_ID}from\"./Klarna.config\";import\"./Klarna.style\";export var CartDispatcher=import(/* webpackMode: \"lazy\", webpackChunkName: \"dispatchers\" */\"/home/marketihor/scandipwa/packages/scandipwa/src/store/Cart/Cart.dispatcher\");/** @namespace Component/Klarna/Component */var _checkBEM=require(\"babel-plugin-transform-rebem-jsx\").checkBEMProps;export var _Klarna=/*#__PURE__*/function(_Extensible){_inherits(_Klarna,_Extensible);var _super=_createSuper(_Klarna);function _Klarna(){var _this;_classCallCheck(this,_Klarna);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.state={isLoading:true,canShowPaymentSelector:true,paymentIsShown:false};_this.loadPaymentMethodPayLater=function(){_this.loadPaymentMethod('pay_later');};_this.loadPaymentMethodPayNow=function(){_this.loadPaymentMethod('pay_now');};_this.loadPaymentMethodPayOverTime=function(){_this.loadPaymentMethod('pay_over_time');};return _this;}_createClass(_Klarna,[{key:\"componentWillUnmount\",value:function componentWillUnmount(){var paymentIsShown=this.state.paymentIsShown;if(paymentIsShown){var klarnaDOM=document.getElementById(KLARNA_PAYMENTS_DEVICE_RECOGNITION_ID);if(klarnaDOM){klarnaDOM.remove();}}}},{key:\"initiateKlarna\",value:function(){var _initiateKlarna=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _this$props,showError,setOrderButtonEnableStatus,guest_cart_id,_yield$fetchMutation,client_token;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_this$props=this.props,showError=_this$props.showError,setOrderButtonEnableStatus=_this$props.setOrderButtonEnableStatus;guest_cart_id=getGuestQuoteId();_context.prev=2;setOrderButtonEnableStatus(false);_context.next=6;return fetchMutation(KlarnaQuery.getCreateKlarnaTokenMutation(!isSignedIn()?{guest_cart_id:guest_cart_id}:{}));case 6:_yield$fetchMutation=_context.sent;client_token=_yield$fetchMutation.klarnaToken;window.Klarna.Payments.init({client_token:client_token});window.Klarna.Payments.load({container:\"#\".concat(KLARNA_PAYMENTS_CONTAINER_ID),payment_method_category:localStorage.getItem('kl_pm')});setOrderButtonEnableStatus(true);_context.next=19;break;case 13:_context.prev=13;_context.t0=_context[\"catch\"](2);console.groupCollapsed('Suppressed error log:');console.error(_context.t0);console.groupEnd();showError(__('Error initializing Klarna payment method.'));case 19:this.setState({isLoading:false});case 20:case\"end\":return _context.stop();}}},_callee,this,[[2,13]]);}));function initiateKlarna(){return _initiateKlarna.apply(this,arguments);}return initiateKlarna;}()},{key:\"renderScript\",value:function renderScript(){window.klarnaAsyncCallback=this.initiateKlarna.bind(this);var script=document.getElementById(KLARNA_SCRIPT_ID);if(script){script.parentNode.removeChild(script);}var klarnaScript=document.createElement('script');klarnaScript.setAttribute('id',KLARNA_SCRIPT_ID);klarnaScript.setAttribute('src','https://x.klarnacdn.net/kp/lib/v1/api.js');klarnaScript.async=true;document.head.appendChild(klarnaScript);this.setState({paymentIsShown:true});}},{key:\"loadPaymentMethod\",value:function loadPaymentMethod(method){this.setState({isLoading:true,canShowPaymentSelector:false});localStorage.setItem('kl_pm',method);this.renderScript();}},{key:\"renderPaymentSelector\",value:function renderPaymentSelector(){var canShowPaymentSelector=this.state.canShowPaymentSelector;if(!canShowPaymentSelector){return null;}var setOrderButtonEnableStatus=this.props.setOrderButtonEnableStatus;this.setState({isLoading:false});setOrderButtonEnableStatus(false);return/*#__PURE__*/_checkBEM(React,\"div\",{block:\"Klarna-PaymentSelector\"},/*#__PURE__*/_checkBEM(React,\"button\",{onClick:this.loadPaymentMethodPayLater,block:\"Button\"},__('Pay later')),/*#__PURE__*/_checkBEM(React,\"button\",{onClick:this.loadPaymentMethodPayNow,block:\"Button\"},__('Pay now')),/*#__PURE__*/_checkBEM(React,\"button\",{onClick:this.loadPaymentMethodPayOverTime,block:\"Button\"},__('Pay over time')));}},{key:\"render\",value:function render(){var isLoading=this.state.isLoading;return/*#__PURE__*/_checkBEM(React,\"div\",{block:\"Klarna\"},/*#__PURE__*/_checkBEM(React,Loader,{isLoading:isLoading}),this.renderPaymentSelector(),/*#__PURE__*/_checkBEM(React,\"div\",{id:KLARNA_PAYMENTS_CONTAINER_ID}));}}]);return _Klarna;}(Extensible(PureComponent));Object.defineProperty(_Klarna,'name',{value:'Klarna'});export var Klarna=middleware(_Klarna,\"Component/Klarna/Component\");export default Klarna;","map":{"version":3,"sources":["/home/marketihor/scandipwa/packages/scandipwa/src/component/Klarna/Klarna.component.js"],"names":["PureComponent","Loader","KlarnaQuery","isSignedIn","getGuestQuoteId","fetchMutation","KLARNA_PAYMENTS_CONTAINER_ID","KLARNA_PAYMENTS_DEVICE_RECOGNITION_ID","KLARNA_SCRIPT_ID","CartDispatcher","Klarna","state","isLoading","canShowPaymentSelector","paymentIsShown","loadPaymentMethodPayLater","loadPaymentMethod","loadPaymentMethodPayNow","loadPaymentMethodPayOverTime","klarnaDOM","document","getElementById","remove","props","showError","setOrderButtonEnableStatus","guest_cart_id","getCreateKlarnaTokenMutation","client_token","klarnaToken","window","Payments","init","load","container","payment_method_category","localStorage","getItem","console","groupCollapsed","error","groupEnd","__","setState","klarnaAsyncCallback","initiateKlarna","bind","script","parentNode","removeChild","klarnaScript","createElement","setAttribute","async","head","appendChild","method","setItem","renderScript","renderPaymentSelector","Object","defineProperty","_Klarna","value"],"mappings":"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","sourcesContent":["/* eslint-disable no-console */\n/**\n * ScandiPWA - Progressive Web App for Magento\n *\n * Copyright © Scandiweb, Inc. All rights reserved.\n * See LICENSE for license details.\n *\n * @license OSL-3.0 (Open Software License (\"OSL\") v. 3.0)\n * @package scandipwa/base-theme\n * @link https://github.com/scandipwa/base-theme\n */\n\nimport PropTypes from 'prop-types';\nimport { PureComponent } from 'react';\n\nimport Loader from 'Component/Loader';\nimport KlarnaQuery from 'Query/Klarna.query';\nimport { isSignedIn } from 'Util/Auth';\nimport { getGuestQuoteId } from 'Util/Cart';\nimport { fetchMutation } from 'Util/Request';\n\nimport {\n    KLARNA_PAYMENTS_CONTAINER_ID,\n    KLARNA_PAYMENTS_DEVICE_RECOGNITION_ID,\n    KLARNA_SCRIPT_ID\n} from './Klarna.config';\n\nimport './Klarna.style';\n\nexport const CartDispatcher = import(\n    /* webpackMode: \"lazy\", webpackChunkName: \"dispatchers\" */\n    'Store/Cart/Cart.dispatcher'\n);\n\n/** @namespace Component/Klarna/Component */\nexport class Klarna extends PureComponent {\n    static propTypes = {\n        showError: PropTypes.func.isRequired,\n        setOrderButtonEnableStatus: PropTypes.func.isRequired\n    };\n\n    state = {\n        isLoading: true,\n        canShowPaymentSelector: true,\n        paymentIsShown: false\n    };\n\n    componentWillUnmount() {\n        const { paymentIsShown } = this.state;\n\n        if (paymentIsShown) {\n            const klarnaDOM = document.getElementById(KLARNA_PAYMENTS_DEVICE_RECOGNITION_ID);\n\n            if (klarnaDOM) {\n                klarnaDOM.remove();\n            }\n        }\n    }\n\n    async initiateKlarna() {\n        const { showError, setOrderButtonEnableStatus } = this.props;\n        const guest_cart_id = getGuestQuoteId();\n\n        try {\n            setOrderButtonEnableStatus(false);\n\n            const { klarnaToken: client_token } = await fetchMutation(\n                KlarnaQuery.getCreateKlarnaTokenMutation(\n                    !isSignedIn() ? { guest_cart_id } : {}\n                )\n            );\n\n            window.Klarna.Payments.init({ client_token });\n            window.Klarna.Payments.load({\n                container: `#${KLARNA_PAYMENTS_CONTAINER_ID}`,\n                payment_method_category: localStorage.getItem('kl_pm')\n            });\n\n            setOrderButtonEnableStatus(true);\n        } catch (err) {\n            console.groupCollapsed('Suppressed error log:');\n            console.error(err);\n            console.groupEnd();\n\n            showError(__('Error initializing Klarna payment method.'));\n        }\n\n        this.setState({ isLoading: false });\n    }\n\n    renderScript() {\n        window.klarnaAsyncCallback = this.initiateKlarna.bind(this);\n        const script = document.getElementById(KLARNA_SCRIPT_ID);\n\n        if (script) {\n            script.parentNode.removeChild(script);\n        }\n\n        const klarnaScript = document.createElement('script');\n        klarnaScript.setAttribute('id', KLARNA_SCRIPT_ID);\n        klarnaScript.setAttribute('src', 'https://x.klarnacdn.net/kp/lib/v1/api.js');\n        klarnaScript.async = true;\n        document.head.appendChild(klarnaScript);\n\n        this.setState({ paymentIsShown: true });\n    }\n\n    loadPaymentMethod(method) {\n        this.setState({\n            isLoading: true,\n            canShowPaymentSelector: false\n        });\n        localStorage.setItem('kl_pm', method);\n        this.renderScript();\n    }\n\n    loadPaymentMethodPayLater = () => {\n        this.loadPaymentMethod('pay_later');\n    };\n\n    loadPaymentMethodPayNow = () => {\n        this.loadPaymentMethod('pay_now');\n    };\n\n    loadPaymentMethodPayOverTime = () => {\n        this.loadPaymentMethod('pay_over_time');\n    };\n\n    renderPaymentSelector() {\n        const { canShowPaymentSelector } = this.state;\n\n        if (!canShowPaymentSelector) {\n            return null;\n        }\n\n        const { setOrderButtonEnableStatus } = this.props;\n\n        this.setState({ isLoading: false });\n        setOrderButtonEnableStatus(false);\n\n        return (\n            <div block=\"Klarna-PaymentSelector\">\n                <button\n                  onClick={ this.loadPaymentMethodPayLater }\n                  block=\"Button\"\n                >\n                    { __('Pay later') }\n                </button>\n\n                <button\n                  onClick={ this.loadPaymentMethodPayNow }\n                  block=\"Button\"\n                >\n                    { __('Pay now') }\n                </button>\n\n                <button\n                  onClick={ this.loadPaymentMethodPayOverTime }\n                  block=\"Button\"\n                >\n                    { __('Pay over time') }\n                </button>\n            </div>\n        );\n    }\n\n    render() {\n        const { isLoading } = this.state;\n\n        return (\n            <div block=\"Klarna\">\n                <Loader isLoading={ isLoading } />\n                { this.renderPaymentSelector() }\n                <div id={ KLARNA_PAYMENTS_CONTAINER_ID } />\n            </div>\n        );\n    }\n}\n\nexport default Klarna;\n"]},"metadata":{},"sourceType":"module"}