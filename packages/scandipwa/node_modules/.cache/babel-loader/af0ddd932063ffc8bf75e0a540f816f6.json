{"ast":null,"code":"import _regeneratorRuntime from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _objectSpread from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _toConsumableArray from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _classCallCheck from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _get from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/get\";import _getPrototypeOf from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";/**\n * ScandiPWA - Progressive Web App for Magento\n *\n * Copyright © Scandiweb, Inc. All rights reserved.\n * See LICENSE for license details.\n *\n * @license OSL-3.0 (Open Software License (\"OSL\") v. 3.0)\n * @package scandipwa/base-theme\n * @link https://github.com/scandipwa/base-theme\n */import ProductListQuery from\"/home/marketihor/scandipwa/packages/scandipwa/src/query/ProductList.query\";import{updateLinkedProducts}from\"/home/marketihor/scandipwa/packages/scandipwa/src/store/LinkedProducts/LinkedProducts.action\";import{showNotification}from\"/home/marketihor/scandipwa/packages/scandipwa/src/store/Notification/Notification.action\";import BrowserDatabase from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/BrowserDatabase\";import{getIndexedProduct}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Product\";import{fetchQuery,QueryDispatcher}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Request\";import{ONE_MONTH_IN_SECONDS}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Request/QueryDispatcher\";export var LINKED_PRODUCTS='LINKED_PRODUCTS';/**\n * Linked Prodcts List Dispatcher\n * @class LinkedProductsDispatcher\n * @extends QueryDispatcher\n * @namespace Store/LinkedProducts/Dispatcher\n */export var _LinkedProductsDispatcher=/*#__PURE__*/function(_Extensible){_inherits(_LinkedProductsDispatcher,_Extensible);var _super=_createSuper(_LinkedProductsDispatcher);function _LinkedProductsDispatcher(){_classCallCheck(this,_LinkedProductsDispatcher);return _super.apply(this,arguments);}_createClass(_LinkedProductsDispatcher,[{key:\"__construct\",value:function __construct(){_get(_getPrototypeOf(_LinkedProductsDispatcher.prototype),\"__construct\",this).call(this,'LinkedProducts',ONE_MONTH_IN_SECONDS);}},{key:\"onSuccess\",value:function onSuccess(data,dispatch,product_links){var linkedProducts=this._processResponse(data,product_links);BrowserDatabase.setItem(linkedProducts,LINKED_PRODUCTS);dispatch(updateLinkedProducts(linkedProducts));}},{key:\"onError\",value:function onError(error,dispatch){dispatch(showNotification('error',__('Error fetching LinkedProducts!'),error));}/**\n     * Prepare LinkedProducts query\n     * @return {Query} ProductList query\n     * @memberof LinkedProductsDispatcher\n     * @param product_links\n     */},{key:\"prepareRequest\",value:function prepareRequest(product_links){var relatedSKUs=product_links.reduce(function(links,link){var linked_product_sku=link.linked_product_sku;return[].concat(_toConsumableArray(links),[\"\".concat(linked_product_sku.replace(/ /g,'%20'))]);},[]);return[ProductListQuery.getQuery({args:{filter:{productsSkuArray:relatedSKUs}},notRequireInfo:true})];}/**\n     * Clear linked products list\n     * @param {{productsSkuArray: Array<String>}} options A object containing different aspects of query, each item can be omitted\n     * @return {Query} ProductList query\n     * @memberof LinkedProductsDispatcher\n     */},{key:\"clearLinkedProducts\",value:function clearLinkedProducts(dispatch){var updateCrossSell=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var linkedProducts={upsell:{total_count:0,items:[]},related:{total_count:0,items:[]},crosssell:{total_count:0,items:[]}};BrowserDatabase.setItem(linkedProducts,LINKED_PRODUCTS);dispatch(updateLinkedProducts(_objectSpread(_objectSpread({},linkedProducts),{},{updateCrossSell:updateCrossSell})));}},{key:\"fetchCrossSellProducts\",value:function(){var _fetchCrossSellProducts=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(dispatch,product_links){var query,data,_this$_processRespons,crosssell,linkedProducts;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:query=this.prepareRequest(product_links);_context.next=3;return fetchQuery(query);case 3:data=_context.sent;_this$_processRespons=this._processResponse(data,product_links),crosssell=_this$_processRespons.crosssell;linkedProducts=BrowserDatabase.getItem(LINKED_PRODUCTS);Object.assign(linkedProducts,{crosssell:crosssell,updateCrossSell:true});dispatch(updateLinkedProducts(linkedProducts));case 8:case\"end\":return _context.stop();}}},_callee,this);}));function fetchCrossSellProducts(_x,_x2){return _fetchCrossSellProducts.apply(this,arguments);}return fetchCrossSellProducts;}()},{key:\"clearCrossSellProducts\",value:function clearCrossSellProducts(dispatch){var linkedProducts=BrowserDatabase.getItem(LINKED_PRODUCTS)||{};Object.assign(linkedProducts,{crosssell:{total_count:0,items:[]},updateCrossSell:true});dispatch(updateLinkedProducts(linkedProducts));}},{key:\"_processResponse\",value:function _processResponse(data,product_links){var items=data.products.items;var indexedBySku=items.reduce(function(acc,item){var sku=item.sku;acc[sku]=getIndexedProduct(item);return acc;},{});var linkedProducts=product_links.reduce(function(acc,link){var linked_product_sku=link.linked_product_sku,link_type=link.link_type;if(indexedBySku[linked_product_sku]&&acc[link_type]){acc[link_type].items.push(indexedBySku[linked_product_sku]);acc[link_type].total_count++;}return acc;},{upsell:{total_count:0,items:[]},related:{total_count:0,items:[]},crosssell:{total_count:0,items:[]},associated:{total_count:0,items:[]}});return linkedProducts;}}]);return _LinkedProductsDispatcher;}(Extensible(QueryDispatcher));Object.defineProperty(_LinkedProductsDispatcher,'name',{value:'LinkedProductsDispatcher'});export var LinkedProductsDispatcher=middleware(_LinkedProductsDispatcher,\"Store/LinkedProducts/Dispatcher\");export default new LinkedProductsDispatcher();","map":{"version":3,"sources":["/home/marketihor/scandipwa/packages/scandipwa/src/store/LinkedProducts/LinkedProducts.dispatcher.js"],"names":["ProductListQuery","updateLinkedProducts","showNotification","BrowserDatabase","getIndexedProduct","fetchQuery","QueryDispatcher","ONE_MONTH_IN_SECONDS","LINKED_PRODUCTS","LinkedProductsDispatcher","data","dispatch","product_links","linkedProducts","_processResponse","setItem","error","__","relatedSKUs","reduce","links","link","linked_product_sku","replace","getQuery","args","filter","productsSkuArray","notRequireInfo","updateCrossSell","upsell","total_count","items","related","crosssell","query","prepareRequest","getItem","Object","assign","products","indexedBySku","acc","item","sku","link_type","push","associated","defineProperty","_LinkedProductsDispatcher","value"],"mappings":"44CAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAEA,MAAOA,CAAAA,gBAAP,iFACA,OAASC,oBAAT,oGACA,OAASC,gBAAT,gGACA,MAAOC,CAAAA,eAAP,8EACA,OAASC,iBAAT,sEACA,OAASC,UAAT,CAAqBC,eAArB,sEACA,OAASC,oBAAT,sFAEA,MAAO,IAAMC,CAAAA,eAAe,CAAG,iBAAxB,CAEP;AACA;AACA;AACA;AACA;AACA,GACA,UAAaC,CAAAA,yBAAb,mUACI,sBAAc,CACV,wFAAkB,gBAAlB,CAAoCF,oBAApC,EACH,CAHL,yBAKI,mBAAUG,IAAV,CAAgBC,QAAhB,CAA0BC,aAA1B,CAAyC,CACrC,GAAMC,CAAAA,cAAc,CAAG,KAAKC,gBAAL,CAAsBJ,IAAtB,CAA4BE,aAA5B,CAAvB,CAEAT,eAAe,CAACY,OAAhB,CAAwBF,cAAxB,CAAwCL,eAAxC,EACAG,QAAQ,CAACV,oBAAoB,CAACY,cAAD,CAArB,CAAR,CACH,CAVL,uBAYI,iBAAQG,KAAR,CAAeL,QAAf,CAAyB,CACrBA,QAAQ,CAACT,gBAAgB,CAAC,OAAD,CAAUe,EAAE,CAAC,gCAAD,CAAZ,CAAgDD,KAAhD,CAAjB,CAAR,CACH,CAED;AACJ;AACA;AACA;AACA;AACA,OArBA,8BAsBI,wBAAeJ,aAAf,CAA8B,CAC1B,GAAMM,CAAAA,WAAW,CAAGN,aAAa,CAACO,MAAd,CAAqB,SAACC,KAAD,CAAQC,IAAR,CAAiB,IAC9CC,CAAAA,kBAD8C,CACvBD,IADuB,CAC9CC,kBAD8C,CAEtD,mCAAWF,KAAX,aAAsBE,kBAAkB,CAACC,OAAnB,CAA2B,IAA3B,CAAiC,KAAjC,CAAtB,IACH,CAHmB,CAGjB,EAHiB,CAApB,CAKA,MAAO,CACHvB,gBAAgB,CAACwB,QAAjB,CAA0B,CACtBC,IAAI,CAAE,CACFC,MAAM,CAAE,CACJC,gBAAgB,CAAET,WADd,CADN,CADgB,CAMtBU,cAAc,CAAE,IANM,CAA1B,CADG,CAAP,CAUH,CAED;AACJ;AACA;AACA;AACA;AACA,OA7CA,mCA8CI,6BAAoBjB,QAApB,CAAuD,IAAzBkB,CAAAA,eAAyB,2DAAP,KAAO,CACnD,GAAMhB,CAAAA,cAAc,CAAG,CACnBiB,MAAM,CAAE,CAAEC,WAAW,CAAE,CAAf,CAAkBC,KAAK,CAAE,EAAzB,CADW,CAEnBC,OAAO,CAAE,CAAEF,WAAW,CAAE,CAAf,CAAkBC,KAAK,CAAE,EAAzB,CAFU,CAGnBE,SAAS,CAAE,CAAEH,WAAW,CAAE,CAAf,CAAkBC,KAAK,CAAE,EAAzB,CAHQ,CAAvB,CAMA7B,eAAe,CAACY,OAAhB,CAAwBF,cAAxB,CAAwCL,eAAxC,EAEAG,QAAQ,CAACV,oBAAoB,gCACtBY,cADsB,MAEzBgB,eAAe,CAAfA,eAFyB,GAArB,CAAR,CAIH,CA3DL,qIA6DI,iBAA6BlB,QAA7B,CAAuCC,aAAvC,gLACUuB,KADV,CACkB,KAAKC,cAAL,CAAoBxB,aAApB,CADlB,uBAEuBP,CAAAA,UAAU,CAAC8B,KAAD,CAFjC,QAEUzB,IAFV,qCAG0B,KAAKI,gBAAL,CAAsBJ,IAAtB,CAA4BE,aAA5B,CAH1B,CAGYsB,SAHZ,uBAGYA,SAHZ,CAIUrB,cAJV,CAI2BV,eAAe,CAACkC,OAAhB,CAAwB7B,eAAxB,CAJ3B,CAMI8B,MAAM,CAACC,MAAP,CAAc1B,cAAd,CAA8B,CAC1BqB,SAAS,CAATA,SAD0B,CAE1BL,eAAe,CAAE,IAFS,CAA9B,EAKAlB,QAAQ,CAACV,oBAAoB,CAACY,cAAD,CAArB,CAAR,CAXJ,2DA7DJ,wKA2EI,gCAAuBF,QAAvB,CAAiC,CAC7B,GAAME,CAAAA,cAAc,CAAGV,eAAe,CAACkC,OAAhB,CAAwB7B,eAAxB,GAA4C,EAAnE,CAEA8B,MAAM,CAACC,MAAP,CAAc1B,cAAd,CAA8B,CAC1BqB,SAAS,CAAE,CAAEH,WAAW,CAAE,CAAf,CAAkBC,KAAK,CAAE,EAAzB,CADe,CAE1BH,eAAe,CAAE,IAFS,CAA9B,EAKAlB,QAAQ,CAACV,oBAAoB,CAACY,cAAD,CAArB,CAAR,CACH,CApFL,gCAsFI,0BAAiBH,IAAjB,CAAuBE,aAAvB,CAAsC,IACdoB,CAAAA,KADc,CACFtB,IADE,CAC1B8B,QAD0B,CACdR,KADc,CAGlC,GAAMS,CAAAA,YAAY,CAAGT,KAAK,CAACb,MAAN,CAAa,SAACuB,GAAD,CAAMC,IAAN,CAAe,IACrCC,CAAAA,GADqC,CAC7BD,IAD6B,CACrCC,GADqC,CAE7CF,GAAG,CAACE,GAAD,CAAH,CAAWxC,iBAAiB,CAACuC,IAAD,CAA5B,CACA,MAAOD,CAAAA,GAAP,CACH,CAJoB,CAIlB,EAJkB,CAArB,CAMA,GAAM7B,CAAAA,cAAc,CAAGD,aAAa,CAACO,MAAd,CAAqB,SAACuB,GAAD,CAAMrB,IAAN,CAAe,IAC/CC,CAAAA,kBAD+C,CACbD,IADa,CAC/CC,kBAD+C,CAC3BuB,SAD2B,CACbxB,IADa,CAC3BwB,SAD2B,CAGvD,GAAIJ,YAAY,CAACnB,kBAAD,CAAZ,EAAoCoB,GAAG,CAACG,SAAD,CAA3C,CAAwD,CACpDH,GAAG,CAACG,SAAD,CAAH,CAAeb,KAAf,CAAqBc,IAArB,CACIL,YAAY,CAACnB,kBAAD,CADhB,EAIAoB,GAAG,CAACG,SAAD,CAAH,CAAed,WAAf,GACH,CAED,MAAOW,CAAAA,GAAP,CACH,CAZsB,CAYpB,CACCZ,MAAM,CAAE,CAAEC,WAAW,CAAE,CAAf,CAAkBC,KAAK,CAAE,EAAzB,CADT,CAECC,OAAO,CAAE,CAAEF,WAAW,CAAE,CAAf,CAAkBC,KAAK,CAAE,EAAzB,CAFV,CAGCE,SAAS,CAAE,CAAEH,WAAW,CAAE,CAAf,CAAkBC,KAAK,CAAE,EAAzB,CAHZ,CAICe,UAAU,CAAE,CAAEhB,WAAW,CAAE,CAAf,CAAkBC,KAAK,CAAE,EAAzB,CAJb,CAZoB,CAAvB,CAmBA,MAAOnB,CAAAA,cAAP,CACH,CAnHL,oEA3BAyB,MAAM,CAACU,cAAP,CAAsBC,yBAAtB,CAAiD,MAAjD,CAAyD,CAAEC,KAAK,CAAE,0BAAT,CAAzD,E,4GAiJA,cAAe,IAAIzC,CAAAA,wBAAJ,EAAf","sourcesContent":["/**\n * ScandiPWA - Progressive Web App for Magento\n *\n * Copyright © Scandiweb, Inc. All rights reserved.\n * See LICENSE for license details.\n *\n * @license OSL-3.0 (Open Software License (\"OSL\") v. 3.0)\n * @package scandipwa/base-theme\n * @link https://github.com/scandipwa/base-theme\n */\n\nimport ProductListQuery from 'Query/ProductList.query';\nimport { updateLinkedProducts } from 'Store/LinkedProducts/LinkedProducts.action';\nimport { showNotification } from 'Store/Notification/Notification.action';\nimport BrowserDatabase from 'Util/BrowserDatabase';\nimport { getIndexedProduct } from 'Util/Product';\nimport { fetchQuery, QueryDispatcher } from 'Util/Request';\nimport { ONE_MONTH_IN_SECONDS } from 'Util/Request/QueryDispatcher';\n\nexport const LINKED_PRODUCTS = 'LINKED_PRODUCTS';\n\n/**\n * Linked Prodcts List Dispatcher\n * @class LinkedProductsDispatcher\n * @extends QueryDispatcher\n * @namespace Store/LinkedProducts/Dispatcher\n */\nexport class LinkedProductsDispatcher extends QueryDispatcher {\n    __construct() {\n        super.__construct('LinkedProducts', ONE_MONTH_IN_SECONDS);\n    }\n\n    onSuccess(data, dispatch, product_links) {\n        const linkedProducts = this._processResponse(data, product_links);\n\n        BrowserDatabase.setItem(linkedProducts, LINKED_PRODUCTS);\n        dispatch(updateLinkedProducts(linkedProducts));\n    }\n\n    onError(error, dispatch) {\n        dispatch(showNotification('error', __('Error fetching LinkedProducts!'), error));\n    }\n\n    /**\n     * Prepare LinkedProducts query\n     * @return {Query} ProductList query\n     * @memberof LinkedProductsDispatcher\n     * @param product_links\n     */\n    prepareRequest(product_links) {\n        const relatedSKUs = product_links.reduce((links, link) => {\n            const { linked_product_sku } = link;\n            return [...links, `${ linked_product_sku.replace(/ /g, '%20') }`];\n        }, []);\n\n        return [\n            ProductListQuery.getQuery({\n                args: {\n                    filter: {\n                        productsSkuArray: relatedSKUs\n                    }\n                },\n                notRequireInfo: true\n            })\n        ];\n    }\n\n    /**\n     * Clear linked products list\n     * @param {{productsSkuArray: Array<String>}} options A object containing different aspects of query, each item can be omitted\n     * @return {Query} ProductList query\n     * @memberof LinkedProductsDispatcher\n     */\n    clearLinkedProducts(dispatch, updateCrossSell = false) {\n        const linkedProducts = {\n            upsell: { total_count: 0, items: [] },\n            related: { total_count: 0, items: [] },\n            crosssell: { total_count: 0, items: [] }\n        };\n\n        BrowserDatabase.setItem(linkedProducts, LINKED_PRODUCTS);\n\n        dispatch(updateLinkedProducts({\n            ...linkedProducts,\n            updateCrossSell\n        }));\n    }\n\n    async fetchCrossSellProducts(dispatch, product_links) {\n        const query = this.prepareRequest(product_links);\n        const data = await fetchQuery(query);\n        const { crosssell } = this._processResponse(data, product_links);\n        const linkedProducts = BrowserDatabase.getItem(LINKED_PRODUCTS);\n\n        Object.assign(linkedProducts, {\n            crosssell,\n            updateCrossSell: true\n        });\n\n        dispatch(updateLinkedProducts(linkedProducts));\n    }\n\n    clearCrossSellProducts(dispatch) {\n        const linkedProducts = BrowserDatabase.getItem(LINKED_PRODUCTS) || {};\n\n        Object.assign(linkedProducts, {\n            crosssell: { total_count: 0, items: [] },\n            updateCrossSell: true\n        });\n\n        dispatch(updateLinkedProducts(linkedProducts));\n    }\n\n    _processResponse(data, product_links) {\n        const { products: { items } } = data;\n\n        const indexedBySku = items.reduce((acc, item) => {\n            const { sku } = item;\n            acc[sku] = getIndexedProduct(item);\n            return acc;\n        }, {});\n\n        const linkedProducts = product_links.reduce((acc, link) => {\n            const { linked_product_sku, link_type } = link;\n\n            if (indexedBySku[linked_product_sku] && acc[link_type]) {\n                acc[link_type].items.push(\n                    indexedBySku[linked_product_sku]\n                );\n\n                acc[link_type].total_count++;\n            }\n\n            return acc;\n        }, {\n            upsell: { total_count: 0, items: [] },\n            related: { total_count: 0, items: [] },\n            crosssell: { total_count: 0, items: [] },\n            associated: { total_count: 0, items: [] }\n        });\n\n        return linkedProducts;\n    }\n}\n\nexport default new LinkedProductsDispatcher();\n"]},"metadata":{},"sourceType":"module"}