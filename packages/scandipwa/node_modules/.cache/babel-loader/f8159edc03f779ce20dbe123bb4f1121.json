{"ast":null,"code":"import _defineProperty from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _objectSpread from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _toConsumableArray from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _asyncToGenerator from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _get from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/get\";import _getPrototypeOf from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/getPrototypeOf\";import _inherits from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";/**\n * ScandiPWA - Progressive Web App for Magento\n *\n * Copyright © Scandiweb, Inc. All rights reserved.\n * See LICENSE for license details.\n *\n * @license OSL-3.0 (Open Software License (\"OSL\") v. 3.0)\n * @package scandipwa/base-theme\n * @link https://github.com/scandipwa/base-theme\n */import{Children,cloneElement,createRef,PureComponent}from'react';import{FieldContainer}from\"/home/marketihor/scandipwa/packages/scandipwa/src/component/Field/Field.container\";import{ChildrenType,MixType}from\"/home/marketihor/scandipwa/packages/scandipwa/src/type/Common\";import FormPortalCollector from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/FormPortalCollector\";import validationConfig from\"./Form.config\";/** @namespace Component/Form/Component */var _checkBEM=require(\"babel-plugin-transform-rebem-jsx\").checkBEMProps;export var _Form=/*#__PURE__*/function(_Extensible){_inherits(_Form,_Extensible);var _super=_createSuper(_Form);function _Form(){var _this;_classCallCheck(this,_Form);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.handleFormSubmit=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){var _this$props,onSubmitSuccess,onSubmitError,onSubmit,id,portalData,_portalData$reduce,invalidFields,inputValues,asyncData;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_this$props=_this.props,onSubmitSuccess=_this$props.onSubmitSuccess,onSubmitError=_this$props.onSubmitError,onSubmit=_this$props.onSubmit,id=_this$props.id;e.preventDefault();onSubmit();if(!id){_context.next=9;break;}_context.next=6;return window.formPortalCollector.collect(id);case 6:_context.t0=_context.sent;_context.next=10;break;case 9:_context.t0=[];case 10:portalData=_context.t0;_portalData$reduce=portalData.reduce(function(acc,portalData){var _portalData$invalidFi=portalData.invalidFields,invalidFields=_portalData$invalidFi===void 0?[]:_portalData$invalidFi,_portalData$inputValu=portalData.inputValues,inputValues=_portalData$inputValu===void 0?{}:_portalData$inputValu;var initialInvalidFields=acc.invalidFields,initialInputValues=acc.inputValues;return{invalidFields:[].concat(_toConsumableArray(initialInvalidFields),_toConsumableArray(invalidFields)),inputValues:_objectSpread(_objectSpread({},initialInputValues),inputValues)};},_this.collectFieldsInformation()),invalidFields=_portalData$reduce.invalidFields,inputValues=_portalData$reduce.inputValues;asyncData=Promise.all(portalData.reduce(function(acc,_ref2){var asyncData=_ref2.asyncData;if(!asyncData){return acc;}return[].concat(_toConsumableArray(acc),[asyncData]);},[]));asyncData.then(/** @namespace Component/Form/Component/handleFormSubmitAsyncDataThen */middleware(function(asyncDataList){if(!invalidFields.length){onSubmitSuccess(inputValues,asyncDataList);return;}onSubmitError(inputValues,invalidFields);},\"Component/Form/Component/handleFormSubmitAsyncDataThen\"),/** @namespace Component/Form/Component/handleFormSubmitAsyncDataCatch */middleware(function(e){return onSubmitError(inputValues,invalidFields,e);},\"Component/Form/Component/handleFormSubmitAsyncDataCatch\"));case 14:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();_this.collectFieldsInformation=function(){var refMap=_this.state.refMap;var propsChildren=_this.props.children;var _Form$cloneAndValidat=Form.cloneAndValidateChildren(propsChildren,refMap),children=_Form$cloneAndValidat.children,fieldsAreValid=_Form$cloneAndValidat.fieldsAreValid,invalidFields=_Form$cloneAndValidat.invalidFields;_this.setState({children:children,fieldsAreValid:fieldsAreValid});var inputValues=Object.values(refMap).reduce(function(inputValues,input){var current=input.current;if(current&&current.id&&current.value){var name=current.name,value=current.value,checked=current.checked;if(current.dataset.skipValue==='true'){return inputValues;}if(current.type==='checkbox'){var boolValue=checked;return _objectSpread(_objectSpread({},inputValues),{},_defineProperty({},name,boolValue));}return _objectSpread(_objectSpread({},inputValues),{},_defineProperty({},name,value));}return inputValues;},{});if(invalidFields.length){var current=refMap[invalidFields[0]].current;current.scrollIntoView({behavior:'smooth',block:'center'});}return{inputValues:inputValues,invalidFields:invalidFields};};return _this;}_createClass(_Form,[{key:\"__construct\",value:function __construct(props){_get(_getPrototypeOf(_Form.prototype),\"__construct\",this).call(this,props);if(!window.formPortalCollector){window.formPortalCollector=new FormPortalCollector();}this.state=_objectSpread(_objectSpread({},Form.updateChildrenRefs(props)),{},{fieldsAreValid:true});}},{key:\"render\",value:function render(){var _this2=this;var _this$props2=this.props,mix=_this$props2.mix,id=_this$props2.id;var _this$state=this.state,children=_this$state.children,fieldsAreValid=_this$state.fieldsAreValid;return/*#__PURE__*/_checkBEM(React,\"form\",{block:\"Form\",mix:mix,mods:{isInvalid:!fieldsAreValid},ref:function ref(_ref3){_this2.form=_ref3;},id:id,onSubmit:this.handleFormSubmit},children);}}],[{key:\"updateChildrenRefs\",value:function updateChildrenRefs(props){var state=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var propsChildren=props.children;var _state$refMap=state.refMap,refMapState=_state$refMap===void 0?{}:_state$refMap;var refMap={};var children=Form.cloneChildren(propsChildren,function(child){var name=child.props.name;var _ref4=Object.keys(refMapState).length?Form.validateField(child,refMapState):{},message=_ref4.message;refMap[name]=/*#__PURE__*/createRef();var childProps={formRef:refMap[name],formRefMap:refMap};if(message){childProps.message=message;}return/*#__PURE__*/cloneElement(child,childProps);});return{children:children,refMap:refMap};}},{key:\"cloneChildren\",value:function cloneChildren(originChildren,fieldCallback){var executeClone=function executeClone(originChildren){return Children.map(originChildren,function(child){if(child&&typeof child==='object'&&child.type&&child.props){var name=child.type.name,props=child.props,children=child.props.children;if(name===FieldContainer.prototype.constructor.name){return fieldCallback(child);}if(typeof children==='object'){return/*#__PURE__*/cloneElement(child,_objectSpread(_objectSpread({},props),{},{children:executeClone(children)}));}return child;}return child;});};return executeClone(originChildren);}},{key:\"cloneAndValidateChildren\",value:function cloneAndValidateChildren(propsChildren,refMap){var invalidFields=[];var children=Form.cloneChildren(propsChildren,function(child){var _child$props=child.props,id=_child$props.id,name=_child$props.name;var _Form$validateField=Form.validateField(child,refMap),message=_Form$validateField.message;if(message){invalidFields.push(id);return/*#__PURE__*/cloneElement(child,{message:message,formRef:refMap[name]});}return/*#__PURE__*/cloneElement(child,{formRef:refMap[name]});});return{children:children,fieldsAreValid:!invalidFields.length,invalidFields:invalidFields};}},{key:\"validateField\",value:function validateField(field,refMap){var _field$props=field.props,validation=_field$props.validation,id=_field$props.id,name=_field$props.name;if(validation&&id&&refMap[name]&&refMap[name].current){var inputNode=refMap[name].current;var rule=validation.find(function(rule){if(!validationConfig[rule]){return false;}var validationRules=validationConfig[rule];var isValid=validationRules.validate(inputNode,refMap);return!isValid;});if(rule){return validationConfig[rule];}}return{};}},{key:\"getDerivedStateFromProps\",value:function getDerivedStateFromProps(props,state){var refMap=state.refMap;var children=props.children;return _objectSpread(_objectSpread({},Form.cloneAndValidateChildren(children,refMap)),Form.updateChildrenRefs(props,state));}}]);return _Form;}(Extensible(PureComponent));_Form.defaultProps={onSubmitSuccess:function onSubmitSuccess(){},onSubmitError:function onSubmitError(){},onSubmit:function onSubmit(){},mix:{},id:''};Object.defineProperty(_Form,'name',{value:'Form'});export var Form=middleware(_Form,\"Component/Form/Component\");export default Form;","map":{"version":3,"sources":["/home/marketihor/scandipwa/packages/scandipwa/src/component/Form/Form.component.js"],"names":["Children","cloneElement","createRef","PureComponent","FieldContainer","ChildrenType","MixType","FormPortalCollector","validationConfig","Form","handleFormSubmit","e","props","onSubmitSuccess","onSubmitError","onSubmit","id","preventDefault","window","formPortalCollector","collect","portalData","reduce","acc","invalidFields","inputValues","initialInvalidFields","initialInputValues","collectFieldsInformation","asyncData","Promise","all","then","asyncDataList","length","refMap","state","propsChildren","children","cloneAndValidateChildren","fieldsAreValid","setState","Object","values","input","current","value","name","checked","dataset","skipValue","type","boolValue","scrollIntoView","behavior","block","updateChildrenRefs","mix","isInvalid","ref","form","refMapState","cloneChildren","child","keys","validateField","message","childProps","formRef","formRefMap","originChildren","fieldCallback","executeClone","map","prototype","constructor","push","field","validation","inputNode","rule","find","validationRules","isValid","validate","defaultProps","defineProperty","_Form"],"mappings":"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","sourcesContent":["/**\n * ScandiPWA - Progressive Web App for Magento\n *\n * Copyright © Scandiweb, Inc. All rights reserved.\n * See LICENSE for license details.\n *\n * @license OSL-3.0 (Open Software License (\"OSL\") v. 3.0)\n * @package scandipwa/base-theme\n * @link https://github.com/scandipwa/base-theme\n */\n\nimport PropTypes from 'prop-types';\nimport {\n    Children,\n    cloneElement,\n    createRef,\n    PureComponent\n} from 'react';\n\nimport { FieldContainer } from 'Component/Field/Field.container';\nimport { ChildrenType, MixType } from 'Type/Common';\nimport FormPortalCollector from 'Util/FormPortalCollector';\n\nimport validationConfig from './Form.config';\n\n/** @namespace Component/Form/Component */\nexport class Form extends PureComponent {\n    static propTypes = {\n        onSubmitSuccess: PropTypes.func,\n        onSubmitError: PropTypes.func,\n        onSubmit: PropTypes.func,\n        children: ChildrenType.isRequired,\n        id: PropTypes.string,\n        mix: MixType\n    };\n\n    static defaultProps = {\n        onSubmitSuccess: () => {},\n        onSubmitError: () => {},\n        onSubmit: () => {},\n        mix: {},\n        id: ''\n    };\n\n    static updateChildrenRefs(props, state = {}) {\n        const { children: propsChildren } = props;\n        const { refMap: refMapState = {} } = state;\n\n        const refMap = {};\n\n        const children = Form.cloneChildren(\n            propsChildren,\n            (child) => {\n                const { props: { name } } = child;\n                const { message } = Object.keys(refMapState).length\n                    ? Form.validateField(child, refMapState)\n                    : {};\n\n                refMap[name] = createRef();\n\n                const childProps = {\n                    formRef: refMap[name],\n                    formRefMap: refMap\n                };\n\n                if (message) {\n                    childProps.message = message;\n                }\n\n                return cloneElement(child, childProps);\n            }\n        );\n\n        return { children, refMap };\n    }\n\n    static cloneChildren(originChildren, fieldCallback) {\n        const executeClone = (originChildren) => Children.map(originChildren, (child) => {\n            if (child && typeof child === 'object' && child.type && child.props) {\n                const { type: { name }, props, props: { children } } = child;\n\n                if (name === FieldContainer.prototype.constructor.name) {\n                    return fieldCallback(child);\n                }\n\n                if (typeof children === 'object') {\n                    return cloneElement(child, {\n                        ...props,\n                        children: executeClone(children)\n                    });\n                }\n\n                return child;\n            }\n\n            return child;\n        });\n\n        return executeClone(originChildren);\n    }\n\n    static cloneAndValidateChildren(propsChildren, refMap) {\n        const invalidFields = [];\n        const children = Form.cloneChildren(\n            propsChildren,\n            (child) => {\n                const { props: { id, name } } = child;\n                const { message } = Form.validateField(child, refMap);\n\n                if (message) {\n                    invalidFields.push(id);\n                    return cloneElement(child, {\n                        message,\n                        formRef: refMap[name]\n                    });\n                }\n\n                return cloneElement(child, {\n                    formRef: refMap[name]\n                });\n            }\n        );\n\n        return { children, fieldsAreValid: !invalidFields.length, invalidFields };\n    }\n\n    static validateField(field, refMap) {\n        const { validation, id, name } = field.props;\n\n        if (validation && id && refMap[name] && refMap[name].current) {\n            const { current: inputNode } = refMap[name];\n\n            const rule = validation.find((rule) => {\n                if (!validationConfig[rule]) {\n                    return false;\n                }\n                const validationRules = validationConfig[rule];\n                const isValid = validationRules.validate(inputNode, refMap);\n                return !isValid;\n            });\n\n            if (rule) {\n                return validationConfig[rule];\n            }\n        }\n\n        return {};\n    }\n\n    __construct(props) {\n        super.__construct(props);\n\n        if (!window.formPortalCollector) {\n            window.formPortalCollector = new FormPortalCollector();\n        }\n\n        this.state = {\n            ...Form.updateChildrenRefs(props),\n            fieldsAreValid: true\n        };\n    }\n\n    static getDerivedStateFromProps(props, state) {\n        const { refMap } = state;\n        const { children } = props;\n\n        return {\n            ...Form.cloneAndValidateChildren(children, refMap),\n            ...Form.updateChildrenRefs(props, state)\n        };\n    }\n\n    handleFormSubmit = async (e) => {\n        const {\n            onSubmitSuccess,\n            onSubmitError,\n            onSubmit,\n            id\n        } = this.props;\n\n        e.preventDefault();\n        onSubmit();\n\n        const portalData = id ? await window.formPortalCollector.collect(id) : [];\n\n        const {\n            invalidFields,\n            inputValues\n        } = portalData.reduce((acc, portalData) => {\n            const {\n                invalidFields = [],\n                inputValues = {}\n            } = portalData;\n\n            const {\n                invalidFields: initialInvalidFields,\n                inputValues: initialInputValues\n            } = acc;\n\n            return ({\n                invalidFields: [...initialInvalidFields, ...invalidFields],\n                inputValues: { ...initialInputValues, ...inputValues }\n            });\n        }, this.collectFieldsInformation());\n\n        const asyncData = Promise.all(portalData.reduce((acc, { asyncData }) => {\n            if (!asyncData) {\n                return acc;\n            }\n\n            return [...acc, asyncData];\n        }, []));\n\n        asyncData.then(\n            /** @namespace Component/Form/Component/handleFormSubmitAsyncDataThen */\n            (asyncDataList) => {\n                if (!invalidFields.length) {\n                    onSubmitSuccess(inputValues, asyncDataList);\n                    return;\n                }\n\n                onSubmitError(inputValues, invalidFields);\n            },\n            /** @namespace Component/Form/Component/handleFormSubmitAsyncDataCatch */\n            (e) => onSubmitError(inputValues, invalidFields, e)\n        );\n    };\n\n    collectFieldsInformation = () => {\n        const { refMap } = this.state;\n        const { children: propsChildren } = this.props;\n\n        const {\n            children,\n            fieldsAreValid,\n            invalidFields\n        } = Form.cloneAndValidateChildren(propsChildren, refMap);\n\n        this.setState({ children, fieldsAreValid });\n\n        const inputValues = Object.values(refMap).reduce((inputValues, input) => {\n            const { current } = input;\n            if (current && current.id && current.value) {\n                const { name, value, checked } = current;\n\n                if (current.dataset.skipValue === 'true') {\n                    return inputValues;\n                }\n\n                if (current.type === 'checkbox') {\n                    const boolValue = checked;\n                    return { ...inputValues, [name]: boolValue };\n                }\n\n                return { ...inputValues, [name]: value };\n            }\n\n            return inputValues;\n        }, {});\n\n        if (invalidFields.length) {\n            const { current } = refMap[invalidFields[0]];\n\n            current.scrollIntoView({\n                behavior: 'smooth',\n                block: 'center'\n            });\n        }\n\n        return {\n            inputValues,\n            invalidFields\n        };\n    };\n\n    render() {\n        const { mix, id } = this.props;\n        const { children, fieldsAreValid } = this.state;\n\n        return (\n            <form\n              block=\"Form\"\n              mix={ mix }\n              mods={ { isInvalid: !fieldsAreValid } }\n              ref={ (ref) => {\n                  this.form = ref;\n              } }\n              id={ id }\n              onSubmit={ this.handleFormSubmit }\n            >\n                { children }\n            </form>\n        );\n    }\n}\n\nexport default Form;\n"]},"metadata":{},"sourceType":"module"}