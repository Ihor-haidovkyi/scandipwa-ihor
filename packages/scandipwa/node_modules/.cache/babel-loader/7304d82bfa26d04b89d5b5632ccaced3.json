{"ast":null,"code":"import _objectSpread from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/marketihor/scandipwa/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";/**\n * ScandiPWA - Progressive Web App for Magento\n *\n * Copyright © Scandiweb, Inc. All rights reserved.\n * See LICENSE for license details.\n *\n * @license OSL-3.0 (Open Software License (\"OSL\") v. 3.0)\n * @package scandipwa/base-theme\n * @link https://github.com/scandipwa/base-theme\n */import CartQuery from\"/home/marketihor/scandipwa/packages/scandipwa/src/query/Cart.query\";import{updateTotals}from\"/home/marketihor/scandipwa/packages/scandipwa/src/store/Cart/Cart.action\";import{showNotification}from\"/home/marketihor/scandipwa/packages/scandipwa/src/store/Notification/Notification.action\";import{isSignedIn}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Auth\";import{getGuestQuoteId,setGuestQuoteId}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Cart\";import{getExtensionAttributes}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Product\";import{fetchMutation,fetchQuery,getErrorMessage}from\"/home/marketihor/scandipwa/packages/scandipwa/src/util/Request\";export var LinkedProductsDispatcher=import(/* webpackMode: \"lazy\", webpackChunkName: \"dispatchers\" */\"/home/marketihor/scandipwa/packages/scandipwa/src/store/LinkedProducts/LinkedProducts.dispatcher\");/**\n * Product Cart Dispatcher\n * @class CartDispatcher\n * @namespace Store/Cart/Dispatcher\n */export var _CartDispatcher=/*#__PURE__*/function(_Extensible){_inherits(_CartDispatcher,_Extensible);var _super=_createSuper(_CartDispatcher);function _CartDispatcher(){_classCallCheck(this,_CartDispatcher);return _super.apply(this,arguments);}_createClass(_CartDispatcher,[{key:\"updateInitialCartData\",value:function(){var _updateInitialCartData=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(dispatch){var quoteId,_yield$fetchQuery,_yield$fetchQuery$car,cartData;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return this._getGuestQuoteId(dispatch);case 3:quoteId=_context.sent;_context.next=6;return fetchQuery(CartQuery.getCartQuery(!isSignedIn()&&quoteId));case 6:_yield$fetchQuery=_context.sent;_yield$fetchQuery$car=_yield$fetchQuery.cartData;cartData=_yield$fetchQuery$car===void 0?{}:_yield$fetchQuery$car;return _context.abrupt(\"return\",this._updateCartData(cartData,dispatch));case 12:_context.prev=12;_context.t0=_context[\"catch\"](0);return _context.abrupt(\"return\",this.createGuestEmptyCart(dispatch));case 15:case\"end\":return _context.stop();}}},_callee,this,[[0,12]]);}));function updateInitialCartData(_x){return _updateInitialCartData.apply(this,arguments);}return updateInitialCartData;}()},{key:\"createGuestEmptyCart\",value:function(){var _createGuestEmptyCart=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(dispatch){var _yield$fetchMutation,_yield$fetchMutation$,quoteId;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return fetchMutation(CartQuery.getCreateEmptyCartMutation());case 3:_yield$fetchMutation=_context2.sent;_yield$fetchMutation$=_yield$fetchMutation.createEmptyCart;quoteId=_yield$fetchMutation$===void 0?'':_yield$fetchMutation$;setGuestQuoteId(quoteId);this._updateCartData({},dispatch);return _context2.abrupt(\"return\",quoteId);case 11:_context2.prev=11;_context2.t0=_context2[\"catch\"](0);dispatch(showNotification('error',getErrorMessage(_context2.t0)));return _context2.abrupt(\"return\",null);case 15:case\"end\":return _context2.stop();}}},_callee2,this,[[0,11]]);}));function createGuestEmptyCart(_x2){return _createGuestEmptyCart.apply(this,arguments);}return createGuestEmptyCart;}()},{key:\"mergeCarts\",value:function(){var _mergeCarts=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(sourceCartId,destinationCartId,dispatch){var _yield$fetchMutation2,_yield$fetchMutation3,_yield$fetchMutation4,id;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return fetchMutation(CartQuery.getMergeCartQuery(sourceCartId,destinationCartId));case 3:_yield$fetchMutation2=_context3.sent;_yield$fetchMutation3=_yield$fetchMutation2.mergeCarts;_yield$fetchMutation3=_yield$fetchMutation3===void 0?{}:_yield$fetchMutation3;_yield$fetchMutation4=_yield$fetchMutation3.id,id=_yield$fetchMutation4===void 0?'':_yield$fetchMutation4;return _context3.abrupt(\"return\",id);case 10:_context3.prev=10;_context3.t0=_context3[\"catch\"](0);dispatch(showNotification('error',getErrorMessage(_context3.t0)));return _context3.abrupt(\"return\",null);case 14:case\"end\":return _context3.stop();}}},_callee3,null,[[0,10]]);}));function mergeCarts(_x3,_x4,_x5){return _mergeCarts.apply(this,arguments);}return mergeCarts;}()},{key:\"resetGuestCart\",value:function resetGuestCart(dispatch){return this._updateCartData({},dispatch);}},{key:\"changeItemQty\",value:function(){var _changeItemQty=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(dispatch,options){var item_id,quantity,sku,isCustomerSignedIn,guestQuoteId,_yield$fetchMutation5,_yield$fetchMutation6,_yield$fetchMutation7,cartData;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:item_id=options.item_id,quantity=options.quantity,sku=options.sku;_context4.prev=1;isCustomerSignedIn=isSignedIn();guestQuoteId=!isCustomerSignedIn&&getGuestQuoteId();if(!(!isCustomerSignedIn&&!guestQuoteId)){_context4.next=6;break;}return _context4.abrupt(\"return\",Promise.reject());case 6:_context4.next=8;return fetchMutation(CartQuery.getSaveCartItemMutation({sku:sku,item_id:item_id,quantity:quantity},guestQuoteId));case 8:_yield$fetchMutation5=_context4.sent;_yield$fetchMutation6=_yield$fetchMutation5.saveCartItem;_yield$fetchMutation6=_yield$fetchMutation6===void 0?{}:_yield$fetchMutation6;_yield$fetchMutation7=_yield$fetchMutation6.cartData,cartData=_yield$fetchMutation7===void 0?{}:_yield$fetchMutation7;return _context4.abrupt(\"return\",this._updateCartData(cartData,dispatch));case 15:_context4.prev=15;_context4.t0=_context4[\"catch\"](1);dispatch(showNotification('error',getErrorMessage(_context4.t0)));return _context4.abrupt(\"return\",Promise.reject());case 19:case\"end\":return _context4.stop();}}},_callee4,this,[[1,15]]);}));function changeItemQty(_x6,_x7){return _changeItemQty.apply(this,arguments);}return changeItemQty;}()},{key:\"addProductToCart\",value:function(){var _addProductToCart=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(dispatch,options){var product,quantity,productOptionsData,buyRequest,sku,product_type,_ref,productOptions,productOptionsMulti,downloadableLinks,productToAdd,isCustomerSignedIn,guestQuoteId,_yield$fetchMutation8,_yield$fetchMutation9,_yield$fetchMutation10,cartData;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:product=options.product,quantity=options.quantity,productOptionsData=options.productOptionsData,buyRequest=options.buyRequest;sku=product.sku,product_type=product.type_id;_ref=productOptionsData||{},productOptions=_ref.productOptions,productOptionsMulti=_ref.productOptionsMulti,downloadableLinks=_ref.downloadableLinks;productToAdd={sku:sku,product_type:product_type,quantity:quantity,product_option:{buy_request:buyRequest,extension_attributes:getExtensionAttributes(_objectSpread(_objectSpread({},product),{},{productOptions:productOptions,productOptionsMulti:productOptionsMulti,downloadableLinks:downloadableLinks}))}};if(!this._canBeAdded(options)){_context5.next=23;break;}_context5.prev=5;isCustomerSignedIn=isSignedIn();guestQuoteId=!isCustomerSignedIn&&getGuestQuoteId();if(!(!isCustomerSignedIn&&!guestQuoteId)){_context5.next=10;break;}return _context5.abrupt(\"return\",Promise.reject());case 10:_context5.next=12;return fetchMutation(CartQuery.getSaveCartItemMutation(productToAdd,guestQuoteId));case 12:_yield$fetchMutation8=_context5.sent;_yield$fetchMutation9=_yield$fetchMutation8.saveCartItem;_yield$fetchMutation9=_yield$fetchMutation9===void 0?{}:_yield$fetchMutation9;_yield$fetchMutation10=_yield$fetchMutation9.cartData,cartData=_yield$fetchMutation10===void 0?{}:_yield$fetchMutation10;return _context5.abrupt(\"return\",this._updateCartData(cartData,dispatch));case 19:_context5.prev=19;_context5.t0=_context5[\"catch\"](5);dispatch(showNotification('error',getErrorMessage(_context5.t0)));return _context5.abrupt(\"return\",Promise.reject());case 23:return _context5.abrupt(\"return\",Promise.reject());case 24:case\"end\":return _context5.stop();}}},_callee5,this,[[5,19]]);}));function addProductToCart(_x8,_x9){return _addProductToCart.apply(this,arguments);}return addProductToCart;}()},{key:\"removeProductFromCart\",value:function(){var _removeProductFromCart=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(dispatch,item_id){var isCustomerSignedIn,guestQuoteId,_yield$fetchMutation11,_yield$fetchMutation12,_yield$fetchMutation13,cartData;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.prev=0;isCustomerSignedIn=isSignedIn();guestQuoteId=!isCustomerSignedIn&&getGuestQuoteId();if(!(!isCustomerSignedIn&&!guestQuoteId)){_context6.next=5;break;}return _context6.abrupt(\"return\",null);case 5:_context6.next=7;return fetchMutation(CartQuery.getRemoveCartItemMutation(item_id,guestQuoteId));case 7:_yield$fetchMutation11=_context6.sent;_yield$fetchMutation12=_yield$fetchMutation11.removeCartItem;_yield$fetchMutation12=_yield$fetchMutation12===void 0?{}:_yield$fetchMutation12;_yield$fetchMutation13=_yield$fetchMutation12.cartData,cartData=_yield$fetchMutation13===void 0?{}:_yield$fetchMutation13;this._updateCartData(cartData,dispatch);return _context6.abrupt(\"return\",cartData);case 15:_context6.prev=15;_context6.t0=_context6[\"catch\"](0);dispatch(showNotification('error',getErrorMessage(_context6.t0)));return _context6.abrupt(\"return\",null);case 19:case\"end\":return _context6.stop();}}},_callee6,this,[[0,15]]);}));function removeProductFromCart(_x10,_x11){return _removeProductFromCart.apply(this,arguments);}return removeProductFromCart;}()},{key:\"applyCouponToCart\",value:function(){var _applyCouponToCart=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(dispatch,couponCode){var isCustomerSignedIn,guestQuoteId,_yield$fetchMutation14,_yield$fetchMutation15,_yield$fetchMutation16,cartData;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.prev=0;isCustomerSignedIn=isSignedIn();guestQuoteId=!isCustomerSignedIn&&getGuestQuoteId();if(!(!isCustomerSignedIn&&!guestQuoteId)){_context7.next=5;break;}return _context7.abrupt(\"return\");case 5:_context7.next=7;return fetchMutation(CartQuery.getApplyCouponMutation(couponCode,guestQuoteId));case 7:_yield$fetchMutation14=_context7.sent;_yield$fetchMutation15=_yield$fetchMutation14.applyCoupon;_yield$fetchMutation15=_yield$fetchMutation15===void 0?{}:_yield$fetchMutation15;_yield$fetchMutation16=_yield$fetchMutation15.cartData,cartData=_yield$fetchMutation16===void 0?{}:_yield$fetchMutation16;this._updateCartData(cartData,dispatch);dispatch(showNotification('success',__('Coupon was applied!')));_context7.next=18;break;case 15:_context7.prev=15;_context7.t0=_context7[\"catch\"](0);dispatch(showNotification('error',getErrorMessage(_context7.t0)));case 18:case\"end\":return _context7.stop();}}},_callee7,this,[[0,15]]);}));function applyCouponToCart(_x12,_x13){return _applyCouponToCart.apply(this,arguments);}return applyCouponToCart;}()},{key:\"removeCouponFromCart\",value:function(){var _removeCouponFromCart=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(dispatch){var isCustomerSignedIn,guestQuoteId,_yield$fetchMutation17,_yield$fetchMutation18,_yield$fetchMutation19,cartData;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.prev=0;isCustomerSignedIn=isSignedIn();guestQuoteId=!isCustomerSignedIn&&getGuestQuoteId();if(!(!isCustomerSignedIn&&!guestQuoteId)){_context8.next=5;break;}return _context8.abrupt(\"return\");case 5:_context8.next=7;return fetchMutation(CartQuery.getRemoveCouponMutation(guestQuoteId));case 7:_yield$fetchMutation17=_context8.sent;_yield$fetchMutation18=_yield$fetchMutation17.removeCoupon;_yield$fetchMutation18=_yield$fetchMutation18===void 0?{}:_yield$fetchMutation18;_yield$fetchMutation19=_yield$fetchMutation18.cartData,cartData=_yield$fetchMutation19===void 0?{}:_yield$fetchMutation19;this._updateCartData(cartData,dispatch);dispatch(showNotification('success',__('Coupon was removed!')));_context8.next=18;break;case 15:_context8.prev=15;_context8.t0=_context8[\"catch\"](0);dispatch(showNotification('error',getErrorMessage(_context8.t0)));case 18:case\"end\":return _context8.stop();}}},_callee8,this,[[0,15]]);}));function removeCouponFromCart(_x14){return _removeCouponFromCart.apply(this,arguments);}return removeCouponFromCart;}()},{key:\"updateCrossSellProducts\",value:function updateCrossSellProducts(items,dispatch){if(items&&items.length){var product_links=items.reduce(function(links,product){var _product$product=product.product,product_links=_product$product.product_links,_product$product$vari=_product$product.variants,variants=_product$product$vari===void 0?[]:_product$product$vari,variantSku=product.sku;var _ref2=variants.find(function(_ref3){var sku=_ref3.sku;return sku===variantSku;})||{},childProductLinks=_ref2.product_links;if(childProductLinks){Object.values(childProductLinks).filter(function(_ref4){var link_type=_ref4.link_type;return link_type==='crosssell';}).map(function(item){return links.push(item);});}if(product_links){Object.values(product_links).filter(function(_ref5){var link_type=_ref5.link_type;return link_type==='crosssell';}).map(function(item){return links.push(item);});}return links;},[]);if(product_links.length!==0){LinkedProductsDispatcher.then(function(_ref6){var dispatcher=_ref6.default;return dispatcher.fetchCrossSellProducts(dispatch,product_links);});}else{LinkedProductsDispatcher.then(function(_ref7){var dispatcher=_ref7.default;return dispatcher.clearCrossSellProducts(dispatch);});}}else{LinkedProductsDispatcher.then(function(_ref8){var dispatcher=_ref8.default;return dispatcher.clearCrossSellProducts(dispatch);});}}},{key:\"_updateCartData\",value:function _updateCartData(cartData,dispatch){dispatch(updateTotals(cartData));}/**\n     * @param {*} attribute\n     * @param {*} product\n     */},{key:\"_getProductAttribute\",value:function _getProductAttribute(attribute,product){var variants=product.variants,configurableVariantIndex=product.configurableVariantIndex,attributeValue=product[attribute];return configurableVariantIndex>=0?variants[configurableVariantIndex][attribute]:attributeValue;}/**\n     * Check if it is allowed to add product to cart\n     * @param {Object} options Cart options\n     * @return {Boolean} Indicates is allowed or not\n     * @memberof CartDispatcher\n     */},{key:\"_canBeAdded\",value:function _canBeAdded(options){if(options.product&&options.quantity&&options.product.quantity+options.quantity<1){return false;}if(options.quantity===0){return false;}return true;}/**\n     * Get quote id. If quote id is missing, fetch it from the BE.\n     * @param Dispatch dispatch\n     * @return string quote id\n     */},{key:\"_getGuestQuoteId\",value:function _getGuestQuoteId(dispatch){var guestQuoteId=getGuestQuoteId();if(guestQuoteId){return guestQuoteId;}return this.createGuestEmptyCart(dispatch);}}]);return _CartDispatcher;}(Extensible());Object.defineProperty(_CartDispatcher,'name',{value:'CartDispatcher'});export var CartDispatcher=middleware(_CartDispatcher,\"Store/Cart/Dispatcher\");export default new CartDispatcher();","map":{"version":3,"sources":["/home/marketihor/scandipwa/packages/scandipwa/src/store/Cart/Cart.dispatcher.js"],"names":["CartQuery","updateTotals","showNotification","isSignedIn","getGuestQuoteId","setGuestQuoteId","getExtensionAttributes","fetchMutation","fetchQuery","getErrorMessage","LinkedProductsDispatcher","CartDispatcher","dispatch","_getGuestQuoteId","quoteId","getCartQuery","cartData","_updateCartData","createGuestEmptyCart","getCreateEmptyCartMutation","createEmptyCart","sourceCartId","destinationCartId","getMergeCartQuery","mergeCarts","id","options","item_id","quantity","sku","isCustomerSignedIn","guestQuoteId","Promise","reject","getSaveCartItemMutation","saveCartItem","product","productOptionsData","buyRequest","product_type","type_id","productOptions","productOptionsMulti","downloadableLinks","productToAdd","product_option","buy_request","extension_attributes","_canBeAdded","getRemoveCartItemMutation","removeCartItem","couponCode","getApplyCouponMutation","applyCoupon","__","getRemoveCouponMutation","removeCoupon","items","length","product_links","reduce","links","variants","variantSku","find","childProductLinks","Object","values","filter","link_type","map","item","push","then","dispatcher","default","fetchCrossSellProducts","clearCrossSellProducts","attribute","configurableVariantIndex","attributeValue","defineProperty","_CartDispatcher","value"],"mappings":"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","sourcesContent":["/**\n * ScandiPWA - Progressive Web App for Magento\n *\n * Copyright © Scandiweb, Inc. All rights reserved.\n * See LICENSE for license details.\n *\n * @license OSL-3.0 (Open Software License (\"OSL\") v. 3.0)\n * @package scandipwa/base-theme\n * @link https://github.com/scandipwa/base-theme\n */\n\nimport CartQuery from 'Query/Cart.query';\nimport { updateTotals } from 'Store/Cart/Cart.action';\nimport { showNotification } from 'Store/Notification/Notification.action';\nimport { isSignedIn } from 'Util/Auth';\nimport { getGuestQuoteId, setGuestQuoteId } from 'Util/Cart';\nimport { getExtensionAttributes } from 'Util/Product';\nimport { fetchMutation, fetchQuery, getErrorMessage } from 'Util/Request';\n\nexport const LinkedProductsDispatcher = import(\n    /* webpackMode: \"lazy\", webpackChunkName: \"dispatchers\" */\n    'Store/LinkedProducts/LinkedProducts.dispatcher'\n);\n\n/**\n * Product Cart Dispatcher\n * @class CartDispatcher\n * @namespace Store/Cart/Dispatcher\n */\nexport class CartDispatcher {\n    async updateInitialCartData(dispatch) {\n        // Need to get current cart from BE, update cart\n        try {\n            // ! Get quote token first (local or from the backend) just to make sure it exists\n            const quoteId = await this._getGuestQuoteId(dispatch);\n            const { cartData = {} } = await fetchQuery(\n                CartQuery.getCartQuery(\n                    !isSignedIn() && quoteId\n                )\n            );\n\n            return this._updateCartData(cartData, dispatch);\n        } catch (error) {\n            return this.createGuestEmptyCart(dispatch);\n        }\n    }\n\n    async createGuestEmptyCart(dispatch) {\n        try {\n            const {\n                createEmptyCart: quoteId = ''\n            } = await fetchMutation(CartQuery.getCreateEmptyCartMutation());\n\n            setGuestQuoteId(quoteId);\n            this._updateCartData({}, dispatch);\n            return quoteId;\n        } catch (error) {\n            dispatch(showNotification('error', getErrorMessage(error)));\n            return null;\n        }\n    }\n\n    async mergeCarts(sourceCartId, destinationCartId, dispatch) {\n        try {\n            const {\n                mergeCarts: {\n                    id = ''\n                } = {}\n            } = await fetchMutation(\n                CartQuery.getMergeCartQuery(sourceCartId, destinationCartId)\n            );\n\n            return id;\n        } catch (error) {\n            dispatch(showNotification('error', getErrorMessage(error)));\n            return null;\n        }\n    }\n\n    resetGuestCart(dispatch) {\n        return this._updateCartData({}, dispatch);\n    }\n\n    async changeItemQty(dispatch, options) {\n        const { item_id, quantity, sku } = options;\n\n        try {\n            const isCustomerSignedIn = isSignedIn();\n            const guestQuoteId = !isCustomerSignedIn && getGuestQuoteId();\n\n            if (!isCustomerSignedIn && !guestQuoteId) {\n                return Promise.reject();\n            }\n\n            const { saveCartItem: { cartData = {} } = {} } = await fetchMutation(\n                CartQuery.getSaveCartItemMutation(\n                    { sku, item_id, quantity },\n                    guestQuoteId\n                )\n            );\n\n            return this._updateCartData(cartData, dispatch);\n        } catch (error) {\n            dispatch(showNotification('error', getErrorMessage(error)));\n            return Promise.reject();\n        }\n    }\n\n    async addProductToCart(dispatch, options) {\n        const {\n            product,\n            quantity,\n            productOptionsData,\n            buyRequest\n        } = options;\n\n        const {\n            sku,\n            type_id: product_type\n        } = product;\n\n        const {\n            productOptions,\n            productOptionsMulti,\n            downloadableLinks\n        } = productOptionsData || {};\n\n        const productToAdd = {\n            sku,\n            product_type,\n            quantity,\n            product_option: {\n                buy_request: buyRequest,\n                extension_attributes: getExtensionAttributes(\n                    {\n                        ...product,\n                        productOptions,\n                        productOptionsMulti,\n                        downloadableLinks\n                    }\n                )\n            }\n        };\n\n        if (this._canBeAdded(options)) {\n            try {\n                const isCustomerSignedIn = isSignedIn();\n                const guestQuoteId = !isCustomerSignedIn && getGuestQuoteId();\n\n                if (!isCustomerSignedIn && !guestQuoteId) {\n                    return Promise.reject();\n                }\n\n                const { saveCartItem: { cartData = {} } = {} } = await fetchMutation(\n                    CartQuery.getSaveCartItemMutation(productToAdd, guestQuoteId)\n                );\n\n                return this._updateCartData(cartData, dispatch);\n            } catch (error) {\n                dispatch(showNotification('error', getErrorMessage(error)));\n                return Promise.reject();\n            }\n        }\n\n        return Promise.reject();\n    }\n\n    async removeProductFromCart(dispatch, item_id) {\n        try {\n            const isCustomerSignedIn = isSignedIn();\n            const guestQuoteId = !isCustomerSignedIn && getGuestQuoteId();\n\n            if (!isCustomerSignedIn && !guestQuoteId) {\n                return null;\n            }\n\n            const { removeCartItem: { cartData = {} } = {} } = await fetchMutation(\n                CartQuery.getRemoveCartItemMutation(item_id, guestQuoteId)\n            );\n\n            this._updateCartData(cartData, dispatch);\n            return cartData;\n        } catch (error) {\n            dispatch(showNotification('error', getErrorMessage(error)));\n            return null;\n        }\n    }\n\n    async applyCouponToCart(dispatch, couponCode) {\n        try {\n            const isCustomerSignedIn = isSignedIn();\n            const guestQuoteId = !isCustomerSignedIn && getGuestQuoteId();\n\n            if (!isCustomerSignedIn && !guestQuoteId) {\n                return;\n            }\n\n            const { applyCoupon: { cartData = {} } = {} } = await fetchMutation(\n                CartQuery.getApplyCouponMutation(couponCode, guestQuoteId)\n            );\n\n            this._updateCartData(cartData, dispatch);\n            dispatch(showNotification('success', __('Coupon was applied!')));\n        } catch (error) {\n            dispatch(showNotification('error', getErrorMessage(error)));\n        }\n    }\n\n    async removeCouponFromCart(dispatch) {\n        try {\n            const isCustomerSignedIn = isSignedIn();\n            const guestQuoteId = !isCustomerSignedIn && getGuestQuoteId();\n\n            if (!isCustomerSignedIn && !guestQuoteId) {\n                return;\n            }\n\n            const { removeCoupon: { cartData = {} } = {} } = await fetchMutation(\n                CartQuery.getRemoveCouponMutation(guestQuoteId)\n            );\n\n            this._updateCartData(cartData, dispatch);\n            dispatch(showNotification('success', __('Coupon was removed!')));\n        } catch (error) {\n            dispatch(showNotification('error', getErrorMessage(error)));\n        }\n    }\n\n    updateCrossSellProducts(items, dispatch) {\n        if (items && items.length) {\n            const product_links = items.reduce((links, product) => {\n                const { product: { product_links, variants = [] }, sku: variantSku } = product;\n\n                const { product_links: childProductLinks } = variants.find(({ sku }) => sku === variantSku) || {};\n\n                if (childProductLinks) {\n                    Object.values(childProductLinks).filter(({ link_type }) => link_type === 'crosssell')\n                        .map((item) => links.push(item));\n                }\n\n                if (product_links) {\n                    Object.values(product_links).filter(({ link_type }) => link_type === 'crosssell')\n                        .map((item) => links.push(item));\n                }\n\n                return links;\n            }, []);\n\n            if (product_links.length !== 0) {\n                LinkedProductsDispatcher.then(\n                    ({ default: dispatcher }) => dispatcher.fetchCrossSellProducts(dispatch, product_links)\n                );\n            } else {\n                LinkedProductsDispatcher.then(\n                    ({ default: dispatcher }) => dispatcher.clearCrossSellProducts(dispatch)\n                );\n            }\n        } else {\n            LinkedProductsDispatcher.then(\n                ({ default: dispatcher }) => dispatcher.clearCrossSellProducts(dispatch)\n            );\n        }\n    }\n\n    _updateCartData(cartData, dispatch) {\n        dispatch(updateTotals(cartData));\n    }\n\n    /**\n     * @param {*} attribute\n     * @param {*} product\n     */\n    _getProductAttribute(attribute, product) {\n        const { variants, configurableVariantIndex, [attribute]: attributeValue } = product;\n        return configurableVariantIndex >= 0\n            ? variants[configurableVariantIndex][attribute]\n            : attributeValue;\n    }\n\n    /**\n     * Check if it is allowed to add product to cart\n     * @param {Object} options Cart options\n     * @return {Boolean} Indicates is allowed or not\n     * @memberof CartDispatcher\n     */\n    _canBeAdded(options) {\n        if (options.product && options.quantity && (options.product.quantity + options.quantity) < 1) {\n            return false;\n        }\n\n        if (options.quantity === 0) {\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * Get quote id. If quote id is missing, fetch it from the BE.\n     * @param Dispatch dispatch\n     * @return string quote id\n     */\n    _getGuestQuoteId(dispatch) {\n        const guestQuoteId = getGuestQuoteId();\n\n        if (guestQuoteId) {\n            return guestQuoteId;\n        }\n\n        return this.createGuestEmptyCart(dispatch);\n    }\n}\n\nexport default new CartDispatcher();\n"]},"metadata":{},"sourceType":"module"}